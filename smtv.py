#!/usr/bin/env python*
# -*- coding: UTF-8 -*-


import requests
import csv
import sys


def get_lgtm_project_data(repository_tail):
    # Get lgtm project level data given a repository URL tail like:
    # ('organization/repository_name')
    lgtm_projects_uri = 'https://lgtm.com/api/v1.0/projects/g/'
    r = requests.get(lgtm_projects_uri + repository_tail)
    if r.status_code == 200:
        return r.json()
    else:
        return 0


def get_lgtm_analysis(lgtm_project_id):
    # https://lgtm.com/api/v1.0/analyses/{project-id}/commits/{commit-id}
    lgtm_analyses_uri = 'https://lgtm.com/api/v1.0/analyses/'
    r = requests.get(lgtm_analyses_uri + str(lgtm_project_id) + '/commits/latest')
    if r.status_code == 200:
        return r.json()
    else:
        return 0


def get_lgtm_analysis_details(x):
    # Download full analysis details as csv - lgtm currently only outputs this # as csv or SARIF 
    lgtm_analysis_csv_uri = ''
    r = requests.get(lgtm_analysis_csv_uri + x)


def write_csv(input, file_name):
    output_file = file_name + '.csv'
    fields = input.key()

    with open(output_file, 'w', newline = '',) as f:
        writer = csv.DictWriter(sys.stdout, fields)
        for key,val in input.items():
            print(val)
            writer.writerow(val)

def main():
    # For each repository longtail ('organization/repository_name') try to get # project analysis data from LGTM
    repository = 'pamplemouse9000/AI4Cyber-Team3'
    lgtm_project_data = get_lgtm_project_data(repository)
    if lgtm_project_data != 0:
        lgtm_project_id = lgtm_project_data.get("id")
    else:
        print('Uh oh - we could not retrieve any data for ' + repository + ' :(')
    # Retrieve analysis
    lgtm_analysis = get_lgtm_analysis(lgtm_project_id)

    print(lgtm_analysis)

    print('\n\n' + '..........')

    write_csv(lgtm_project_data,'test')







    # print('Repository: ' + repository + '\n')
    # print('- - - - - - - - - - - - - - - - - - - - - - - -' + '\n')
    # print('LGTM Project Data: ' + str(lgtm_project_data) + '\n')
    # print('- - - - - - - - - - - - - - - - - - - - - - - -' + '\n')
    # print('LGTM Analysis: ' + str(lgtm_analysis) + '\n')
    # print('- - - - - - - - - - - - - - - - - - - - - - - -' + '\n')
    # print('...Done!')


if __name__ == "__main__":
    # execute only if run as a script
    main()
    

